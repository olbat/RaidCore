--------------------------------------------------------------------------------
-- Module Declaration
--

local core = Apollo.GetPackage("Gemini:Addon-1.1").tPackage:GetAddon("RaidCore")

local mod = core:NewBoss("SystemDeamons", 52)
if not mod then return end

mod:RegisterEnableMob("Binärsystem-Dämon","Nullsystem-Dämon") -- Binary System Daemon, Null System Daemon

--------------------------------------------------------------------------------
-- Locals
--

local discoCount, sdwaveCount, probeCount, sdSurgeCount = 0, 0, 0, {}
local phase2warn, phase2 = false, false
local intNorth, intSouth = nil, nil
local prev = 0
local nbKick = 2

--------------------------------------------------------------------------------
-- Initialization
--

function mod:OnBossEnable()
	Print(("Module %s loaded"):format(mod.ModuleName))
	Apollo.RegisterEventHandler("UnitCreated", 			"OnUnitCreated", self)
	Apollo.RegisterEventHandler("UnitDestroyed", 		"OnUnitDestroyed", self)
	Apollo.RegisterEventHandler("UnitEnteredCombat", 		"OnCombatStateChanged", self)
	Apollo.RegisterEventHandler("SPELL_CAST_START", 		"OnSpellCastStart", self)
	Apollo.RegisterEventHandler("SPELL_CAST_END", 		"OnSpellCastEnd", self)
	Apollo.RegisterEventHandler("UNIT_HEALTH", 			"OnHealthChanged", self)
	Apollo.RegisterEventHandler("CHAT_DATACHRON", 		"OnChatDC", self)
	--Apollo.RegisterEventHandler("RAID_WIPE", 			"OnReset", self)
	Apollo.RegisterEventHandler("RAID_SYNC", 			"OnSyncRcv", self)
end


--------------------------------------------------------------------------------
-- Event Handlers
--

function mod:OnUnitCreated(unit)
	local sName = unit:GetName()
	if sName == "Brute Force Algorithm" or sName == "Encryption Program" or sName == "Radiation Dispersion Unit" or sName == "Defragmentation Unit" then
		if phase2 then return end
		local timeOfEvent = GameLib.GetGameTime()
		if timeOfEvent - prev > 48 then
			prev = timeOfEvent
			sdwaveCount = sdwaveCount + 1
			probeCount = 0
			if sdwaveCount == 1 then
				core:AddMsg("SDWAVE", ("[%s] WAVE"):format(sdwaveCount), 5, "Info", "Blue")
				core:AddBar("SDWAVE", ("[%s] WAVE"):format(sdwaveCount + 1), 50, 1)
			elseif sdwaveCount % 2 == 0 then
				core:AddMsg("SDWAVE", ("[%s] WAVE"):format(sdwaveCount), 5, "Info", "Blue")
				core:AddBar("SDWAVE", ("[%s] MINIBOSS"):format(sdwaveCount + 1), 50, 1)
			else
				core:AddMsg("SDWAVE", ("[%s] MINIBOSS"):format(sdwaveCount), 5, "Info", "Blue")
				core:AddBar("SDWAVE", ("[%s] WAVE"):format(sdwaveCount + 1), 50, 1)
			end
		end
	elseif sName == "Nullsystem-Dämon" or sName == "Binärsystem-Dämon" then -- Null System Daemon, Binary System Daemon
		--core:MarkUnit(unit, 0, ("N%s"):format(sdSurgeCount[unit:GetId()] or 0))
		core:MarkUnit(unit, 0, ("%s%s"):format(sName:find("Null") and "S" or "N", sdSurgeCount[unit:GetId()] or 0))
		core:AddUnit(unit)
		core:WatchUnit(unit)
	--elseif sName == "Null System Daemon"  then
	--	core:MarkUnit(unit, 0, ("S%s"):format(sdSurgeCount[unit:GetId()] or 0))
	--	core:AddUnit(unit)
	--	core:WatchUnit(unit)
	elseif sName == "Leistungseinheit V1" then -- Conduction Unit Mk. I
		if probeCount == 0 then probeCount = 1 end
		if GetCurrentSubZoneName():find("Infinite Generator Core") then core:MarkUnit(unit, 1, 1) end -- Infinite Generator Core
	elseif sName == "Leistungseinheit V2" then -- Conduction Unit Mk. II
		if probeCount == 1 then probeCount = 2 end
		if GetCurrentSubZoneName():find("Infinite Generator Core") then core:MarkUnit(unit, 1, 2) end -- Infinite Generator Core
	elseif sName == "Leistungseinheit V3" then -- Conduction Unit Mark III
		if probeCount == 2 then probeCount = 3 end
		if GetCurrentSubZoneName():find("Infinite Generator Core") then core:MarkUnit(unit, 1, 3) end -- Infinite Generator Core
	elseif sName == "Verbesserungsmodul" then -- Enhancement Module
		--Print("Adding Lines for " .. unit:GetId())
		core:MarkUnit(unit, 0)
		core:AddUnit(unit)
		core:AddLine(unit:GetId().."_1", 2, unit, nil, 1, 25, 90)
		core:AddLine(unit:GetId().."_2", 2, unit, nil, 2, 25, -90)
	end
end

function mod:OnUnitDestroyed(unit)
	local sName = unit:GetName()
	if sName == "Verbesserungsmodul" then -- Enhancement Module
		--Print("Dropping Lines for " .. unit:GetId())
		core:DropLine(unit:GetId().."_1")
		core:DropLine(unit:GetId().."_2")
	end	
end

function mod:OnHealthChanged(unitName, health)
	if health >= 70 and health <= 72 and not phase2warn and not phase2 then
		phase2warn = true
		core:AddMsg("SDP2", "P2 SOON !", 5, "Info")
	elseif health >= 70 and health <= 32 and not phase2warn and not phase2 then
		phase2warn = true
		core:AddMsg("SDP2", "P2 SOON !", 5, "Info")		
	end
end

local function dist2unit(unitSource, unitTarget)
	if not unitSource or not unitTarget then return 999 end
	local sPos = unitSource:GetPosition()
	local tPos = unitTarget:GetPosition()

	local sVec = Vector3.New(sPos.x, sPos.y, sPos.z)
	local tVec = Vector3.New(tPos.x, tPos.y, tPos.z)

	local dist = (tVec - sVec):Length()

	return tonumber(dist)
end


function mod:OnSpellCastEnd(unitName, castName, unit)
	if unitName == "Binärsystem-Dämon" and castName == "Energieschweller" then -- Binary System Daemon, Power Surge
		core:MarkUnit(unit, 0, ("N%s"):format(sdSurgeCount[unit:GetId()]))
	elseif unitName == "Nullsystem-Dämon" and castName == "Energieschweller" then	 -- Null System Daemon, Power Surge
		core:MarkUnit(unit, 0, ("S%s"):format(sdSurgeCount[unit:GetId()]))	
	end
end


function mod:OnSpellCastStart(unitName, castName, unit)
	if unitName == "Binärsystem-Dämon" and castName == "Energieschweller" then -- Binary System Daemon, Power Surge
		core:SendSync("NORTH_SURGE", unit:GetId())
		if phase2 and dist2unit(GameLib.GetPlayerUnit(), unit) < 40 then
			core:AddMsg("PURGE", "INTERRUPT NORTH", 5, "Alert")
		end		
	elseif unitName == "Nullsystem-Dämon" and castName == "Energieschweller" then -- Null System Daemon, Power Surge
		core:SendSync("SOUTH_SURGE", unit:GetId())
		if phase2 and dist2unit(GameLib.GetPlayerUnit(), unit) < 40 then
			core:AddMsg("PURGE", "INTERRUPT SOUTH", 5, "Alert")
		end			
	elseif castName == "Säubern" then -- Purge
		if dist2unit(GameLib.GetPlayerUnit(), unit) < 40 then
			core:AddMsg("PURGE", "AIDDDDDDDS !", 5, "Beware")
		end
	elseif unitName == "Defragmentierungseinheit" and castName == "Glatteis" then -- Defragmentation Unit, Black IC
		core:AddMsg("BLACKIC", "INTERRUPT !", 5, "Alert")
		core:AddBar("BLACKIC", "BLACK IC", 30)
	end
end

function mod:NextWave()
	Print("ProbeCount : ".. probeCount)
	if probeCount == 3 then
		if sdwaveCount % 2 == 0 then
			core:AddBar("SDWAVE", ("[%s] MINIBOSS"):format(sdwaveCount + 1), 90, 1)
		else
			core:AddBar("SDWAVE", ("[%s] WAVE"):format(sdwaveCount + 1), 90, 1)
		end
	else
		core:AddBar("SDP1", ("[%s] PROBE %s"):format(sdwaveCount, probeCount + 1), 90, 1)
		if sdwaveCount % 2 == 0 then
			core:AddBar("SDWAVE", ("[%s] MINIBOSS"):format(sdwaveCount + 1), 110 + (2 - probeCount) * 10, 1)
		else
			core:AddBar("SDWAVE", ("[%s] WAVE"):format(sdwaveCount + 1), 110 + (2 - probeCount) * 10, 1)
		end
	end
end

function mod:OnChatDC(message)
	if message:find("INVALID SIGNAL. DISCONNECTING") then -- INVALID SIGNAL. DISCONNECTING
		if phase2 then phase2 = false end
		discoCount = discoCount + 1
		if self:Tank() then
			core:AddBar("DISC", ("DISCONNECT (%s)"):format(discoCount + 1), 65)
		end
	elseif message:find("COMMENCING ENHANCEMENT SEQUENCE") then -- COMMENCING ENHANCEMENT SEQUENCE
		phase2, phase2warn = true, false
		core:StopBar("DISC")
		core:StopBar("SDWAVE")
		core:AddMsg("SDP2", "PHASE 2 !", 5, "Alarm")
		if self:Tank() then
			core:AddBar("DISC", ("DISCONNECT (%s)"):format(discoCount + 1), 87)
		end

		self:ScheduleTimer("NextWave", 7)
	end
end

function mod:OnSyncRcv(sync, parameter)
	if sync == "NORTH_SURGE" then
		if intNorth and intNorth == sdSurgeCount[parameter] and not phase2 then
			core:AddMsg("SURGE", "INTERRUPT NORTH", 5, "Alert")
		end

		sdSurgeCount[parameter] = sdSurgeCount[parameter] + 1
		if sdSurgeCount[parameter] > nbKick then sdSurgeCount[parameter] = 1 end
		--Print("NORTH : "..sdSurgeCount[parameter])
		--local unit = GameLib.GetUnitById(parameter)
		--if unit then core:MarkUnit(unit, 0, sdSurgeCount[parameter]) end

		if intNorth and intNorth == sdSurgeCount[parameter] then
			core:AddMsg("SURGE", "YOU ARE NEXT ON NORTH !", 5, "Long", "Blue")
		end
	elseif sync == "SOUTH_SURGE" then
		if intSouth and intSouth == sdSurgeCount[parameter] and not phase2 then
			core:AddMsg("SURGE", "INTERRUPT SOUTH", 5, "Alert")
		end

		sdSurgeCount[parameter] = sdSurgeCount[parameter] + 1
		if sdSurgeCount[parameter] > nbKick then sdSurgeCount[parameter] = 1 end
		--Print("SOUTH : "..sdSurgeCount[parameter])
		--local unit = GameLib.GetUnitById(parameter)
		--if unit then core:MarkUnit(unit, 0, sdSurgeCount[parameter]) end

		if intSouth and intSouth == sdSurgeCount[parameter] then
			core:AddMsg("SURGE", "YOU ARE NEXT ON SOUTH !", 5, "Long", "Blue")
		end
	end
end

function mod:OnCombatStateChanged(unit, bInCombat)
	if unit:GetType() == "NonPlayer" and bInCombat then
		local sName = unit:GetName()

		if sName == "Nullsystem-Dämon"  or  sName == "Binärsystem-Dämon" then -- Null System Daemon, Binary System Daemon
			discoCount, sdwaveCount, probeCount = 0, 0, 0
			phase2warn, phase2 = false, false
			sdSurgeCount[unit:GetId()] = 1
			core:MarkUnit(unit, 0, ("%s%s"):format(sName:find("Null") and "S" or "N", sdSurgeCount[unit:GetId()]))
			core:AddUnit(unit)
			core:WatchUnit(unit)
			core:AddSync("NORTH_SURGE", 5)
			core:AddSync("SOUTH_SURGE", 5)
			if self:Tank() then
				core:AddBar("DISC", ("DISCONNECT (%s)"):format(discoCount + 1), 41)
			end
			core:AddBar("SDWAVE", ("[%s] WAVE"):format(sdwaveCount + 1), 15, 1)
			core:StartScan()
		elseif sName == "Defragmentierungseinheit" then -- Defragmentation Unit
			if GetCurrentSubZoneName():find("Infinite Generator Core") then -- Infinite Generator Core
				core:WatchUnit(unit)
			end
		end
	end
end

function mod:SetInterrupter(position, num)
	if num > nbKick then 
		Print("MORON ! Set a good number")
		return
	end
	if position:lower() == "north" then
		intNorth = num
		Print(("Position %s set for North Boss"):format(num))
	elseif position:lower() == "south" then
		intSouth = num
		Print(("Position %s set for South Boss"):format(num))
	else 
		Print(("Bad Position : %s"):format(position))
	end
end
